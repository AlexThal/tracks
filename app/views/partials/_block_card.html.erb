<% @blocks.each do |block| %>
  <%# START OF BLOCK CARD %>
  <div class ="block-card">
    <% sets = block.exercise_sets %>

    <%# HEADER %>
    <div class = "block-header">
      <li><%= block.name %></li>
      <% unless block.category.nil? || block.category.name.empty? %>
      <p class="category"><%="##{block.category.name}" if block.category%></p>
      <% end %>
    </div>

    <%# SETS AND REPS %>
    <% if sets.length > 0 %>
    <button class="btn btn-outline-dark mt-2 mb-2 dropdown-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample<%=block.id%>" aria-expanded="false" aria-controls="collapseExample">
        <strong><%= "#{sets.length} x #{
          repetitions = sets.map { |set| set.repetitions }
          if repetitions.uniq.size <= 1
            repetitions[0]
          else
            repetitions.join("/")
          end
        }" %></strong></i>
    </button>

      <%# EXTENDED VIEW %>
      <div class="collapse" id="collapseExample<%=block.id%>">
        <hr style="width:100%;text-align:left;margin-left:0">


        <% sets.reverse.each do |set| %>
        <%# SET DETAILS %>
          <div class="set-info">
            <div class="extra-set-fields">
            <%# SETS AND REPS %>
            <% if set.repetitions %>
              <p><%= "#{set.repetitions} x #{set.weight}Kg" if set.repetitions%></p>
            <% end %>
            <%# EXTRA SET FIELDS %>
            <% if set.distance =! ""  %>
            <p><%= "Distance: #{set.distance}"%></p>
            <% end %>
            <% if set.custom_field %>
              <% set.custom_field.each do |key, value| %>
                <p><%= key.capitalize %>: <%= value %></p>
              <% end %>
            <% end %>
            </div>
              <%= link_to exercise_set_path(set),class: "btn-delete", data: { turbo_method: "delete", turbo_confirm: "Are you sure?" } do %>
                <i class="fa-solid fa-circle-minus"></i>
              <% end %>
          </div>
        <% end %>
        <%# ADD SET %>
        <button type="button" class="btn btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#collapseSet<%=block.id%>" aria-expanded="false" aria-controls="collapseExample">
         <i class="fa-solid fa-circle-plus"></i> Set
        </button>
        <div class="collapse" id="collapseSet<%=block.id%>" data-controller="custom-field">
          <%= simple_form_for @set, html: { class: "mt-3"} do |f| %>
              <%= f.hidden_field :block_id, { value: block.id }  %>
              <p>What do you want to track?</p>
              <div class="custom-field-wrapper" data-custom-field-target="pair">
                <input class="custom-field-form form-control string required" type="text" name="set_key" id="set_key" placeholder="reps, weight, distance...">
                <p class="custom-field-form">:</p>
                <input class="custom-field-form form-control string required" type="text" name="set_value" id="set_value" placeholder="12, 40Kg, 12km...">
              </div>
              <i class="custom-field-btn fa-solid fa-circle-plus" data-action="click->custom-field#save"></i>
              <%= f.hidden_field :custom_field, data: { custom_field_target: 'inputField' } %>
              <%= f.submit 'Add set', class: 'btn-main form-actions' %>
          <% end %>
        </div>

        <hr style="width:100%;text-align:left;margin-left:0">
      </div>

    <% end %>

    <div class="block-info">
      <%# EXTRA BLOCK FIELDS %>
      <div class="extra-block-fields">
        <%# NOTE %>
        <% unless block.note.nil? || block.note.empty? %>
          <p><i class="fa-solid fa-note-sticky"></i><%=block.note%></p>
        <% end %>
        <%# GEAR %>
        <% unless block.gear.nil? || block.gear.empty? %>
          <p><i class="fa-solid fa-gear"></i></i> <%= block.gear%></p>
        <% end %>
        <%# REST BETWEEN SETS %>
        <% unless block.rest_between_sets.nil? || block.rest_between_sets.empty? %>
          <p><i class="fa-solid fa-stopwatch"></i> <%= block.rest_between_sets%></p>
        <% end %>
        <% if block.custom_field.is_a?(Hash) %>
          <% block.custom_field.each do |key, value| %>
            <p><%= key.capitalize %>: <%= value %></p>
          <% end %>
        <% end %>
      </div>

      <%# EDIT AND DESTROY BLOCK%>
      <% if current_user == @session.user %>
          <%= link_to session_block_path(@session, block.id),class: "btn-delete", data: { turbo_method: "delete", turbo_confirm: "Are you sure?" } do %>
            <i class="fa-solid fa-trash-can"></i>
          <% end %>
      <% end %>
    </div>

  </div>
  <%# END OF BLOCK CARD %>
<% end %>
